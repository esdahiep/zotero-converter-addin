<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Zotero Converter - Final Version</title>

    <!-- 1. Nạp Office.js từ CDN của Microsoft -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>

    <!-- 2. Giao diện (CSS) -->
    <style>
        :root {
            --primary-color: #8e44ad; /* Màu tím chủ đạo */
            --secondary-color: #2c3e50;
            --background-color: #f4f7f9;
            --font-color: #333;
            --button-text-color: #ffffff;
            --success-color: #27ae60;
            --highlight-color: #f1c40f;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--font-color);
            box-sizing: border-box;
        }
        .container {
            width: 100%;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--secondary-color);
            margin: 0;
            font-size: 1.5em;
        }
        .main-content {
            width: 100%;
            text-align: left;
        }
        .step {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            border-left: 5px solid var(--primary-color);
        }
        .step label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .action-button {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--button-text-color);
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .action-button:hover {
            opacity: 0.9;
        }
        .action-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .conductor-panel {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background-color: #ffffff;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
            display: none; /* Ẩn ban đầu */
        }
        .conductor-panel h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: var(--primary-color);
            text-align: center;
        }
        .instruction {
            margin-bottom: 15px;
        }
        .instruction-step {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .step-number {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .key-display {
            font-family: "Courier New", Courier, monospace;
            background: #e8e8e8;
            padding: 8px;
            border-radius: 4px;
            color: var(--secondary-color);
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #ccc;
        }
        .key-display span {
            color: var(--success-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Trợ lý Điều khiển Tự động</h1>
        </div>

        <div class="main-content">
            <div class="step">
                <label for="jsonFile">Bước 1: Tải lên `master_map.json`</label>
                <input type="file" id="jsonFile" accept=".json">
            </div>
             <div class="step">
                <label>Bước 2: Bắt đầu Hoàn tất</label>
                <button class="action-button" id="start-btn">
                    Tìm & Chuẩn bị Tác vụ Đầu tiên
                </button>
            </div>
        </div>

        <div class="conductor-panel" id="conductor-panel">
            <h2>Tác vụ Tiếp theo</h2>
            <p>Mã khóa dưới đây đã được **tự động sao chép**.</p>
            <div class="key-display">
                Đã sao chép: <span id="current-key"></span>
            </div>
            <div class="instruction">
                <div class="instruction-step">
                    <div class="step-number">1</div>
                    <div>Nhấn nút "Add/Edit Citation" của Zotero.</div>
                </div>
                <div class="instruction-step">
                    <div class="step-number">2</div>
                    <div>Dán (Ctrl+V) và nhấn Enter.</div>
                </div>
                 <div class="instruction-step">
                    <div class="step-number">3</div>
                    <div>Nhấn nút "Tìm Tiếp theo" ở đây.</div>
                </div>
            </div>
            <button class="action-button" id="find-next-btn">Tìm & Chuẩn bị Tác vụ Tiếp theo</button>
        </div>
    </div>

    <!-- Mã JavaScript của Add-in -->
    <script type="text/javascript">
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                console.log("Add-in đã sẵn sàng!");
                document.getElementById("start-btn").onclick = startConductor;
                document.getElementById("find-next-btn").onclick = findNextPlaceholder;
            }
        });

        // Hàm để khởi động "Trợ lý Điều khiển"
        function startConductor() {
            document.getElementById("start-btn").style.display = "none";
            document.getElementById("conductor-panel").style.display = "block";
            findNextPlaceholder(); // Tự động tìm mã khóa đầu tiên
        }

        // Hàm chính để tìm và xử lý mã khóa tiếp theo
        async function findNextPlaceholder() {
            const findButton = document.getElementById("find-next-btn");
            const currentKeySpan = document.getElementById("current-key");

            findButton.disabled = true;
            currentKeySpan.textContent = "Đang tìm...";

            try {
                await Word.run(async (context) => {
                    // Sử dụng API tìm kiếm của Word để tìm mã khóa
                    // {{ZOTERO:*}} là một wildcard expression
                    const searchResults = context.document.body.search("{{ZOTERO:*}}", { matchWildcards: true });
                    context.load(searchResults, 'text');
                    await context.sync();

                    if (searchResults.items.length > 0) {
                        const firstResult = searchResults.items[0];
                        const placeholderText = firstResult.text;
                        
                        // Trích xuất Zotero Key từ mã khóa
                        const zoteroKey = placeholderText.replace("{{ZOTERO:", "").replace("}}", "");

                        // 1. Tự động sao chép Key vào clipboard
                        if (navigator.clipboard) {
                            await navigator.clipboard.writeText(zoteroKey);
                            currentKeySpan.textContent = zoteroKey;
                        } else {
                            currentKeySpan.textContent = "Lỗi: Không thể sao chép";
                        }

                        // 2. Chọn và tô sáng mã khóa trong tài liệu
                        firstResult.select();
                        firstResult.font.highlightColor = '#FFFF00'; // Màu vàng

                        await context.sync();
                    } else {
                        // Không còn mã khóa nào
                        alert("Chúc mừng! Đã xử lý tất cả các trích dẫn.");
                        document.getElementById("conductor-panel").innerHTML = "<h2>Hoàn tất!</h2>";
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Đã xảy ra lỗi: " + error.message);
            } finally {
                findButton.disabled = false;
            }
        }
    </script>
</body>
</html>
